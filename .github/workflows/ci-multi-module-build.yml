name: CI - Multi-Module Build & Push ACR

# 触发条件：代码提交、PR 或手动触发（仅构建，不部署）
on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'KnowGo-common/**'
      - 'KnowGo-business/**'
      - 'KnowGo-server/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'KnowGo-common/**'
      - 'KnowGo-business/**'
      - 'KnowGo-server/**'
  workflow_dispatch:  # 手动触发构建

jobs:
  # 步骤1：全工程 Maven 打包（解决 RAG 模块依赖解析问题）
  full-project-build:
    runs-on: ubuntu-latest
    outputs:
      # 输出镜像标签，供后续步骤复用（也可给 CD 流水线传递）
      image_tag: ${{ github.sha }}
    steps:
      - name: Checkout full code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整仓库历史，保障多模块依赖解析

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven  # 缓存 Maven 依赖，提升构建效率

      - name: Full project Maven clean install
        run: |
          mvn clean install -DskipTests
        env:
          MAVEN_OPTS: '-Xms512m -Xmx1024m'  # 配置 JVM 内存，避免 OOM

      - name: Cache Maven artifacts for sub-modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository/com/fw/
            */target/
          key: ${{ runner.os }}-maven-artifacts-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-maven-artifacts-

  # 步骤2：多模块镜像构建 & 推送 ACR（RAG 优先验证）
  build-and-push-images:
    runs-on: ubuntu-latest
    needs: full-project-build  # 依赖全工程打包完成
    strategy:
      matrix:
        # 保留多模块配置，RAG 模块优先构建
        module: [server, rag, business]
        include:
          - module: server
            context: KnowGo-server
            dockerfile: KnowGo-server/Dockerfile
          - module: rag  # 重点保障 RAG 模块
            context: KnowGo-business/KnowGo-rag
            dockerfile: KnowGo-business/KnowGo-rag/Dockerfile
          - module: business
            context: KnowGo-business/KnowGo-business
            dockerfile: KnowGo-business/KnowGo-business/Dockerfile
      fail-fast: true  # RAG 模块构建失败则终止流水线
      max-parallel: 1  # 串行构建，避免资源竞争

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Maven artifacts from cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository/com/fw/
            */target/
          key: ${{ runner.os }}-maven-artifacts-${{ github.sha }}

      - name: Configure Alibaba Cloud ACR authentication
        uses: aliyun/acr-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.module }} image to ACR
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/knowgo/knowgo-${{ matrix.module }}:${{ github.sha }}
            ${{ secrets.ACR_REGISTRY }}/knowgo/knowgo-${{ matrix.module }}:dev
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
        env:
          DOCKER_BUILDKIT: 1

      - name: Verify RAG module image push
        if: matrix.module == 'rag'  # 仅验证 RAG 模块镜像
        run: |
          echo "=== Verifying RAG Module Image ==="
          docker pull ${{ secrets.ACR_REGISTRY }}/knowgo/knowgo-rag:${{ github.sha }}
          echo "RAG Module image pushed to ACR successfully!"

      - name: Clean up Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache